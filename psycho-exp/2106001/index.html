<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>实验</title>
        <meta name="author" content="Dg_Han">
        <meta name="keywords" content="BART, boredom, risk taking, SBPS">
        <meta name="robots" content="none">
        <style>
            h1, p {
                text-align: center;
            }
            canvas {
                margin: 25px;
                border-width: 1px;
                border-style: solid;
                border-color: black;
            }
            .left{
                float: left;
                width: 75%;
            }
            .right{
                float: left;
                width: 25%;
            }
            .tenth{
                float:left;
                width: 10%;
            }
        </style>

        <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
        <script src="https://cdn.bootcdn.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.js"></script>
        <script>
            var total=0;
            var trial=0;
            var i=-1;
            var sets=[87, 106, 127, 31, 84, 26, 75, 94, 127, 52, 112, 64, 50, 15, 7, 76, 49, 37, 10, 92, 34, 6, 23, 101];
            var SBPS_Q=['时间过得比平时慢。','我容易分心。','现在，似乎所有的事情都能激怒我。','我希望时间能过得更快。','对我来说，所有的事情都是重复的和乏味的。','我感到沮丧。','我不得不做一些对我毫无价值的事情。','我觉得无聊。','对我来说，时间是漫长的。','我比平时更喜怒无常。','我感到焦虑不安。','我觉得空虚。','我很难集中我的注意力。','我想做一些有趣的事情，但是什么都吸引不了我。','时间流逝的非常缓慢。','我希望我做的是令我更兴奋的事情。','我集中注意的时间比平时更短。','现在我没有耐心。','我正在浪费时间，如果把这些时间花在别的事情上会更好。','我在走神。','我希望某件事情发生，但我不确定那是什么事。','此刻，时间好像过得很慢。','我对我周围的人都感到恼火。','我觉得我正在坐等某些事情的发生。'];
            var data={
                bart:new Array(24),
                SBPS_S:new Array(24)
            }

            function show(eId, ...args){
                c=document.getElementById(eId);
                c.style.display="inline";
                for (var j=0, len=(args).length; j<len; j++){
                    c=document.getElementById(args[j]);
                    c.style.display="inline";
                }
            }

            function hide(eId, ...args){
                c=document.getElementById(eId);
                c.style.display="none";
                for (var j=0, len=(args).length; j<len; j++){
                    c=document.getElementById(args[j]);
                    c.style.display="none";
                }
            }
            
            function draw_balloon(r){
                var c=document.getElementById("balloon");
                var b=c.getContext("2d");
                b.fillStyle="#FF0000";
                b.beginPath();
                b.arc(c.width/2,c.height/2,5+2*r,0,2*Math.PI,true);
                b.closePath();
                b.fill();
            }

            function show_earn(){
                p=document.getElementById("total");
                p.innerText="总收益:\n"+(total/100).toString();
                p=document.getElementById("trial");
                p.innerText="本轮收益:\n"+(trial/100).toString();
            }

            function BART_hotkey(event){
                if (event.keyCode==32){
                        pump()
                    }
                    else if (event.keyCode==13){
                        SBPS()
                    }
            }

            function BART(){
                if (i>=0){
                    data.SBPS_S[i]=$("input[type=radio][name=sbps_s]:checked").val()
                    if (data.SBPS_S[i]==undefined){
                        alert("请选择描述与你当前状态的符合程度");
                        return
                    }
                }
                i+=1;
                if (i==24){
                    end();
                    return
                }
                window.removeEventListener('keydown',SBPS_hotkey);
                var c=document.getElementById("balloon");
                cc=c.getContext("2d")
                cc.clearRect(0,0,c.width,c.height);
                draw_balloon(trial);
                hide("welcome");
                show_earn();
                show("bart");
                window.addEventListener('keydown', BART_hotkey);
                hide("sbps");
            }

            function pump(){
                trial+=1;
                if (trial>sets[i]){
                    alert("由于充气过多，气球爆炸了！本轮收益清零。")
                    trial=-1
                    SBPS()
                }
                else{
                    draw_balloon(trial);
                }
                show_earn();
                document.getElementById("pump").blur();
            }

            function SBPS_hotkey(event){
                if (event.keyCode==13){
                    BART()
                }
            }

            function SBPS(){
                window.removeEventListener('keydown', BART_hotkey);
                if (trial>0){
                    total+=trial
                }
                data.bart[i]=trial;
                trial=0
                var s=document.getElementById("sbps_p");
                s.innerText=SBPS_Q[i];
                $("input[name=sbps_s]").removeAttr("checked");
                hide("bart");
                window.addEventListener('keydown', SBPS_hotkey);
                show("sbps");
            }

            function end(){
                hide("sbps");
                //f=fso.OpenTextFile('result.csv',8,true);
                content=JSON.stringify(data);
                var blob=new Blob([content], {type: "text/plain; charset=utf-8"});
                saveAs(blob, "result.json");
                show("end");
            }
        </script>
    </head>

    <body>
        <div id="welcome">
            <h1>欢迎参加实验！</h1>
            <p>指导语：接下来你要完成一项给气球充气的任务。<br>
                每个气球充气次数的上限是128，<font color="red">且每次充气都有相等的概率会爆炸。</font><br>
                你可以在气球爆炸前停止充气，这将得到与充气次数成正比的收益；<br>
                但一旦气球爆炸，该气球的收益将会清零。<br>
                可以通过鼠标左键单击充气按钮进行充气，<br>
                也可以通过键盘空格键进行充气。<br>
                停止充气请鼠标左键单击结束充气按钮，<br>
                或按回车键结束充气。<br>
                在每个充气任务之间还会呈现一些描述性的句子，<br>
                请你根据当前的状态对句子进行评分。1为极不符合，7为极为符合。<br>
                推荐在分辨率在800*600以上的屏幕区域上进行实验。</p>
            <div align="center"><button type="button" id="start" onclick="BART()">开始实验</button></div>
        </div>
        
        <div id="bart" style="display:none">
            <div class="left" align="center"><canvas id="balloon" width="550px" height="550px"></canvas></div>
            <div class="right" align="center">
                <div>
                    <p id="total"></p>
                    <p id="trial"></p>
                </div>
                <div>
                    <button type="button" id="pump" onclick="pump()">充气</button>
                    <button type="button" onclick="SBPS()">结束充气</button>
                </div>
            </div>
        </div>
        <div id="sbps" style="display:none">
            <p id="sbps_p" style="margin-top:100px; margin-bottom:50px"></p>
            <div style="width:100%">
                <div class="tenth" style="margin-left:15%"><label><input type="radio" name="sbps_s" value="1">1<br>极不符合</label></div>
                <div class="tenth"><label><input type="radio" name="sbps_s" value="2">2</label></div>
                <div class="tenth"><label><input type="radio" name="sbps_s" value="3">3</label></div>
                <div class="tenth"><label><input type="radio" name="sbps_s" value="4">4</label></div>
                <div class="tenth"><label><input type="radio" name="sbps_s" value="5">5</label></div>
                <div class="tenth"><label><input type="radio" name="sbps_s" value="6">6</label></div>
                <div class="tenth" style="margin-right:15%"><label><input type="radio" name="sbps_s" value="7">7<br>极为符合</label></div>
            </div>
           <div align="center" style="width:100%"> <button type="button" onclick="BART()">确认</button> </div>
        </div>
        <div id="end" style="display:none">
            <p>实验结束，感谢您的参与！在确定保存数据文件后即可关闭本页面</p>
        </div>
    </body>
</html>
